<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/mystyle.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
</head>
<body>

<!--Navigation Bar. All links are broken currently. Check if links like OSCAR, etc. should be added.-->
<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
  <a class="navbar-brand" href="#">
    <img src="/static/bee.png" alt="logo" style="width:40px;">
  </a>
  
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" href="#">Home</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#">Some Other Link</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#">Yet Another Link</a>
    </li>
  </ul>
</nav>

<!--Adding a jumbotro bar on top. No functionality, just for aesthetics.-->
<div class="jumbotron text-center bg-info text-white" style="margin-bottom:0">
  <h1>Suggested Courses For You</h1>
</div>

<!--Creates some space between the jumbotron and the filters div.-->
<div class="container m-5"></div>

<!--Adding functionality to have negative filters and preferences as well.-->
<script>
  function ts(cb) {
    if (cb.readOnly) {
      cb.checked=cb.readOnly=false;
    }
    else if(!cb.checked) {
      cb.readOnly=cb.indeterminate=true;
    }
    // checked readOnly indeterminate all false -> unchecked
    // checked true -> positive selected
    // readOnly true -> negative selected
  }
</script>

<div class="container">
  <button type="button" class="btn btn-danger btn-lg m-2" id="populate_button">Populate</button>
</div>

<!--Start of the filters container.-->
<div class="container" id="filters_container">
  <div class="row"><h2>FILTERS</h2></div>
  <div class="row">
    <!--Headers for the set of filters provided by us.-->
    <div class="col" style="background-color:lavender;"></div>
    <div class="col" style="background-color:lavender;"><h4>NAME<h4></div>
    <div class="col" style="background-color:lavender;"><h4>PROFESSOR</h4></div>
    <div class="col" style="background-color:lavender;"><h4>FIELD</h4></div>
    <div class="col" style="background-color:lavender;"><h4>LOCATION</h4></div>
    <div class="col" style="background-color:lavender;"><h4>DAYS</h4></div>
  </div>

  <!--A single row depicting all the filters set for this particular course.-->
  <!--This row is replicated to add filters for other courses using the "Add Course" button.-->
  <div id="filters_row_parent">
    <div class="row" id="filters_row_1">
      <div class="col" style="background-color:lavender;"><h4 id="course_1">COURSE 1</h4></div>
      <div class="col" style="background-color:lavender;">
        <!--Course based filter. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Course</button>
          <div class="dropdown-menu scrollable-menu" id = "course_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Professor based filter. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Professor</button>
          <div class="dropdown-menu scrollable-menu" id = "instructor_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Specialization based filter. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Specialization</button>
          <div class="dropdown-menu scrollable-menu" id = "field_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Location based filter. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Location</button>
          <div class="dropdown-menu scrollable-menu" id = "location_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Day of Week based filter. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Day of Week</button>
          <div class="dropdown-menu scrollable-menu" id = "day_names">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--This button helps add more rows to the filters matrix. Calls the fucntion defined below.-->
<div class="container">
  <button type="button" class="btn btn-secondary btn-lg m-2" id="filters_add_course">Add Course</button>
</div>

<script>
  $("#filters_add_course").click(function() {
    // Using jquery, get number of elements with id of the form filters_row_*
    var num_rows = $("#filters_row_parent").children().length;
    var new_row = $("#filters_row_1").clone();
    new_row.attr("id", "filters_row_" + (num_rows + 1));
    new_row.find("h4").attr("id", "course_" + (num_rows + 1));
    new_row.find("h4").text("COURSE " + (num_rows + 1));
    $("#filters_row_parent").append(new_row);
  });

</script>

<!--This container just adds gap between the Filter and Preferences Fields-->
<div class="container m-5"></div>

<!--This is the container for our Preferences Matrix.-->
<div class="container" id="prefs_container">
  <!--A single row depicting all the preferences set for this particular course.-->
  <!--This row is replicated to add preferences for other courses using the "Add Course" button.-->
  <div class="row"><h2>PREFERENCES</h2></div>
  <div class="row">
    <!--Similar to our filters, these are the set of preferences that the user can set.-->
    <div class="col" style="background-color:lavender;"></div>
    <div class="col" style="background-color:lavender;"><h4>NAME<h4></div>
    <div class="col" style="background-color:lavender;"><h4>PROFESSOR</h4></div>
    <div class="col" style="background-color:lavender;"><h4>FIELD</h4></div>
    <div class="col" style="background-color:lavender;"><h4>LOCATION</h4></div>
    <div class="col" style="background-color:lavender;"><h4>DAYS</h4></div>
  </div>

  <div class="row" id="prefs_row">
    <div class="col" style="background-color:lavender;"></div>


      <div class="col" style="background-color:lavender;">
        <!--Course based preference. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Course</button>
          <div class="dropdown-menu scrollable-menu" id = "course_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Professor based preference. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Professor</button>
          <div class="dropdown-menu scrollable-menu" id = "instructor_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Specialization based preference. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Specialization</button>
          <div class="dropdown-menu scrollable-menu" id = "field_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Location based preference. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Location</button>
          <div class="dropdown-menu scrollable-menu" id = "location_names">
          </div>
        </div>
      </div>
      <div class="col" style="background-color:lavender;">
        <!--Day of Week based preference. Users are either want, not want, or not care about courses using a tri-state checkbox.-->
        <div class="btn-group">
          <button type="button" class="btn btn-primary" data-toggle="dropdown">Day of Week</button>
          <div class="dropdown-menu scrollable-menu" id = "day_names">
          </div>
        </div>
      </div>

  </div>
</div>

<!--This is the filter button that users click on once they have set up their filters and preferences.-->
<!--Once clicked, search results are generated and displayed for the user.-->
<div class="container">
  <button type="button" class="btn btn-success btn-lg m-5 btn-block" id = "filter_button">Filter</button>
</div>

<!--Styling for our force directed graph generated.-->
<style>
  .links line {
    stroke: #999;
    stroke-opacity: 0.6;
  }
  
  .nodes circle {
    stroke: #fff;
    stroke-width: 1.5px;
  }
</style>

<!--Setting up the SVG within which our graph will be rendered.-->
<svg width="1920" height="1080"></svg>

<!--Importing D3 libraries and setting up the Force Directed Graph.-->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

  // The following function are redundant, since the nodes are pinned down.
  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }

  // Add on click event for populate_button
  $("#populate_button").click(function() {
    // Make a get to populate endpoint to fetch results in data variable
    $.get("/populate", function(data) {
        // Get a list of courses from data.courses
        var courses = data.courses;
        // Insert an a tag for each course in courses into all divs with id course_names
        $("[id=course_names]").each(function() {
            $(this).empty();
            for (var i = 0; i < courses.length; i++) {
              $(this).append("<a class='dropdown-item' href='#'><input type='checkbox' onClick='ts(this)'/>&nbsp;" + courses[i] + "</a>");
            }
        });


        // Get a list of instructors from data.instructors
        var instructors = data.instructors;
        // Insert an a tag for each instructor in instructors into all divs with id instructor_names
        $("[id=instructor_names]").each(function() {
            $(this).empty();
            for (var i = 0; i < instructors.length; i++) {
              $(this).append("<a class='dropdown-item' href='#'><input type='checkbox' onClick='ts(this)'/>&nbsp;" + instructors[i] + "</a>");
            }
        });
        
        // Get a list of fields from data.fields
        var fields = data.fields;
        // Insert an a tag for each field in fields into all divs with id field_names
        $("[id=field_names]").each(function() {
            $(this).empty();
            for (var i = 0; i < fields.length; i++) {
              $(this).append("<a class='dropdown-item' href='#'><input type='checkbox' onClick='ts(this)'/>&nbsp;" + fields[i] + "</a>");
            }
        });

        // Get a list of locations from data.locations
        var locations = data.locations;
        // Insert an a tag for each location in locations into all divs with id location_names
        $("[id=location_names]").each(function() {
            $(this).empty();
            for (var i = 0; i < locations.length; i++) {
              $(this).append("<a class='dropdown-item' href='#'><input type='checkbox' onClick='ts(this)'/>&nbsp;" + locations[i] + "</a>");
            }
        });

        // Get a list of Days from data.days
        var days = data.days;
        // Insert an a tag for each day in days into all divs with id day_names
        $("[id=day_names]").each(function() {
            $(this).empty();
            for (var i = 0; i < days.length; i++) {
              $(this).append("<a class='dropdown-item' href='#'><input type='checkbox' onClick='ts(this)'/>&nbsp;" + days[i] + "</a>");
            }
        });
    });
  });

  function getFilters(row) {
    // Get the list of selected courses from the course_names div
    var selected_courses = [];
    $(row).find("#course_names").find("input:checked").each(function() {
        selected_courses.push($(this).parent().text().trim());
    });
    var indeterminate_courses = [];
    $(row).find("#course_names").find("input:indeterminate").each(function() {
        indeterminate_courses.push($(this).parent().text().trim());
    });

    // Get the list of selected instructors from the instructor_names div
    var selected_instructors = [];
    $(row).find("#instructor_names").find("input:checked").each(function() {
        selected_instructors.push($(this).parent().text().trim());
    });
    var indeterminate_instructors = [];
    $(row).find("#instructor_names").find("input:indeterminate").each(function() {
        indeterminate_instructors.push($(this).parent().text().trim());
    });

    // Get the list of selected fields from the field_names div
    var selected_fields = [];
    $(row).find("#field_names").find("input:checked").each(function() {
        selected_fields.push($(this).parent().text().trim());
    });
    var indeterminate_fields = [];
    $(row).find("#field_names").find("input:indeterminate").each(function() {
        indeterminate_fields.push($(this).parent().text().trim());
    });

    // Get the list of selected locations from the location_names div
    var selected_locations = [];
    $(row).find("#location_names").find("input:checked").each(function() {
        selected_locations.push($(this).parent().text().trim());
    });
    var indeterminate_locations = [];
    $(row).find("#location_names").find("input:indeterminate").each(function() {
        indeterminate_locations.push($(this).parent().text().trim());
    });

    // Get the list of selected days from the day_names div
    var selected_days = [];
    $(row).find("#day_names").find("input:checked").each(function() {
        selected_days.push($(this).parent().text().trim());
    });
    var indeterminate_days = [];
    $(row).find("#day_names").find("input:indeterminate").each(function() {
        indeterminate_days.push($(this).parent().text().trim());
    });

    // Return the filters
    return {
        "positive_courses_filters": selected_courses,
        "positive_instructors_filters": selected_instructors,
        "positive_fields_filters": selected_fields,
        "positive_locations_filters": selected_locations,
        "positive_days_filters": selected_days,
        "negative_courses_filters": indeterminate_courses,
        "negative_instructors_filters": indeterminate_instructors,
        "negative_fields_filters": indeterminate_fields,
        "negative_locations_filters": indeterminate_locations,
        "negative_days_filters": indeterminate_days
    };
  }

  // Add an on-click event for the search button
  $("#filter_button").click(function() {
    // For every child of the div with id filters_row_parent, call getFilters on it
    filters_list = [];
    $("#filters_row_parent").children().each(function() {
        // Call getFilters and append result to filters_list
        filters_list.push(getFilters($(this)));
    });


    var selected_courses = [];
    $("#prefs_row").find("#course_names").find("input:checked").each(function() {
        selected_courses.push($(this).parent().text().trim());
    });
    var indeterminate_courses = [];
    $("#prefs_row").find("#course_names").find("input:indeterminate").each(function() {
        indeterminate_courses.push($(this).parent().text().trim());
    });

    var selected_instructors = [];
    $("#prefs_row").find("#instructor_names").find("input:checked").each(function() {
        selected_instructors.push($(this).parent().text().trim());
    });
    var indeterminate_instructors = [];
    $("#prefs_row").find("#instructor_names").find("input:indeterminate").each(function() {
        indeterminate_instructors.push($(this).parent().text().trim());
    });

    var selected_fields = [];
    $("#prefs_row").find("#field_names").find("input:checked").each(function() {
        selected_fields.push($(this).parent().text().trim());
    });
    var indeterminate_fields = [];
    $("#prefs_row").find("#field_names").find("input:indeterminate").each(function() {
        indeterminate_fields.push($(this).parent().text().trim());
    });

    var selected_locations = [];
    $("#prefs_row").find("#location_names").find("input:checked").each(function() {
        selected_locations.push($(this).parent().text().trim());
    });
    var indeterminate_locations = [];
    $("#prefs_row").find("#location_names").find("input:indeterminate").each(function() {
        indeterminate_locations.push($(this).parent().text().trim());
    });

    var selected_days = [];
    $("#prefs_row").find("#day_names").find("input:checked").each(function() {
        selected_days.push($(this).parent().text().trim());
    });
    var indeterminate_days = [];
    $("#prefs_row").find("#day_names").find("input:indeterminate").each(function() {
        indeterminate_days.push($(this).parent().text().trim());
    });

    var preferences =  {
        "positive_courses_preferences": selected_courses,
        "positive_instructors_preferences": selected_instructors,
        "positive_fields_preferences": selected_fields,
        "positive_locations_preferences": selected_locations,
        "positive_days_preferences": selected_days,
        "negative_courses_preferences": indeterminate_courses,
        "negative_instructors_preferences": indeterminate_instructors,
        "negative_fields_preferences": indeterminate_fields,
        "negative_locations_preferences": indeterminate_locations,
        "negative_days_preferences": indeterminate_days
    };

    // Send the filters_list to the server, and get the response in the callback
    $.get("/filter", {
        "filters_list": JSON.stringify(filters_list),
        "preferences_list": JSON.stringify(preferences)
    }, function(data) {
      // Clear the contents of svg tag
      d3.select("svg").selectAll("*").remove();
          var svg = d3.select("svg"),
          width = +svg.attr("width"),
          height = +svg.attr("height");

        // Sets the size of the nodes of our graph.
        var radius = 30;

        // This sets a "group number" based coloring scheme for our nodes.
        var color = d3.scaleOrdinal(d3.schemeCategory20);

        var nodes = data.nodes;
        var links = data.links;

        // force("link")  : Determines the length of the link between nodes. Since we're currently pinning nodes to particular coordinated, this is redundant.
        // force("charge"): Determines the force between individual nodes. Helps prevent nodes from overlapping. Redundant due to above reason.
        // force("center"): Determines a particular corrdinate towards which all nodes are attracted. This is to prevent nodes from flying off the SVG viewbox.
        var simulation = d3.forceSimulation()
          .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(250));
      //   .force("charge", d3.forceManyBody().strength(-50))
      //   .force("center", d3.forceCenter(width / 2, height / 2));

        // Adding links to group "g".
        var link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(data.links)
            .enter().append("line")
              .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

        // Adding nodes to the group "g".
        var node = svg.append("g")
          .attr("class", "nodes")
          .selectAll("circle")
          .data(data.nodes)
          .enter().append("circle")
            .attr("r", radius)
            .attr("fill", function(d) { return color(d.group); })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("title")
          .text(function(d) { return d.id; });

        // Adding course names to the nodes.
        var texts = svg.selectAll("text.label")
                  .data(data.nodes)
                  .enter().append("text")
                  .attr("class", "label")
                  .attr("fill", "black")
                  .text(function(d) {  return d.id;  });

        // Initializing the simulation nodes and links.
        simulation
            .nodes(data.nodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(data.links);

        function ticked() {
          // This is the original code where the nodes are not arranged and keep moving around. Leaving it here for future reference.
          // link
          //     .attr("x1", function(d) { return d.source.x; })
          //     .attr("y1", function(d) { return d.source.y; })
          //     .attr("x2", function(d) { return d.target.x; })
          //     .attr("y2", function(d) { return d.target.y; });

          // node
          //     .attr("cx", function(d) { return d.x = Math.max(radius, Math.min(width - radius, d.x));})
          //     .attr("cy", function(d) { return d.y = Math.max(radius, Math.min(height - radius, d.y)); });

          var num_rows = $("#filters_row_parent").children().length;
          // Pinning the nodes down to their respective locations based on their order in the backend returned search results.
          node
              .attr("cx", function(d) { return d.x = ((d.index % num_rows) * width / 5) + 5 * radius;})
              .attr("cy", function(d) { return d.y = ((d.index / num_rows) * (height - num_rows * radius) / 10) + 2 * radius; });
          
          // Moving course names to the updated location of their corresponding nodes.
          texts.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          });

          // Updating the link end points to the updated node locations.
          link
              .attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });
        }
          });

  });

</script>

<!--Helps retrive the next and previous batch of results.-->
<div class="container">
  <ul class="pagination justify-content-end">
    <li class="page-item"><a class="page-link" href="#">Previous</a></li>
    <li class="page-item"><a class="page-link" href="#">Next</a></li>
  </ul>
</div>

</body>
</html>
